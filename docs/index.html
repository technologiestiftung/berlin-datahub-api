<!doctype html>
<html class="default no-js">
<head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<title>berlin-datahub-api - v1.0.1</title>
	<meta name="description" content="Documentation for berlin-datahub-api - v1.0.1">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<link rel="stylesheet" href="assets/css/main.css">
</head>
<body>
<header>
	<div class="tsd-page-toolbar">
		<div class="container">
			<div class="table-wrap">
				<div class="table-cell" id="tsd-search" data-index="assets/js/search.json" data-base=".">
					<div class="field">
						<label for="tsd-search-field" class="tsd-widget search no-caption">Search</label>
						<input id="tsd-search-field" type="text" />
					</div>
					<ul class="results">
						<li class="state loading">Preparing search index...</li>
						<li class="state failure">The search index is not available</li>
					</ul>
					<a href="index.html" class="title">berlin-datahub-api - v1.0.1</a>
				</div>
				<div class="table-cell" id="tsd-widgets">
					<div id="tsd-filter">
						<a href="#" class="tsd-widget options no-caption" data-toggle="options">Options</a>
						<div class="tsd-filter-group">
							<div class="tsd-select" id="tsd-filter-visibility">
								<span class="tsd-select-label">All</span>
								<ul class="tsd-select-list">
									<li data-value="public">Public</li>
									<li data-value="protected">Public/Protected</li>
									<li data-value="private" class="selected">All</li>
								</ul>
							</div>
							<input type="checkbox" id="tsd-filter-inherited" checked />
							<label class="tsd-widget" for="tsd-filter-inherited">Inherited</label>
							<input type="checkbox" id="tsd-filter-externals" checked />
							<label class="tsd-widget" for="tsd-filter-externals">Externals</label>
							<input type="checkbox" id="tsd-filter-only-exported" />
							<label class="tsd-widget" for="tsd-filter-only-exported">Only exported</label>
						</div>
					</div>
					<a href="#" class="tsd-widget menu no-caption" data-toggle="menu">Menu</a>
				</div>
			</div>
		</div>
	</div>
	<div class="tsd-page-title">
		<div class="container">
			<ul class="tsd-breadcrumb">
				<li>
					<a href="globals.html">Globals</a>
				</li>
			</ul>
			<h1>berlin-datahub-api - v1.0.1</h1>
		</div>
	</div>
</header>
<div class="container container-main">
	<div class="row">
		<div class="col-8 col-content">
			<div class="tsd-panel tsd-typography">
				<a href="#berlin-iot-hub-api" id="berlin-iot-hub-api" style="color: inherit; text-decoration: none;">
					<h1>Berlin IoT Hub API</h1>
				</a>
				<!-- @import "[TOC]" {cmd="toc" depthFrom=2 depthTo=6 orderedList=false} -->
				<!-- code_chunk_output -->
				<ul>
					<li><a href="#berlin-iot-hub-api">Berlin IoT Hub API</a><ul>
							<li><a href="#berlin-iot-hub-technology-stack">Berlin IoT Hub Technology Stack</a></li>
							<li><a href="#development">Development</a><ul>
									<li><a href="#environment-variables">Environment Variables</a></li>
									<li><a href="#prerequisites">Prerequisites</a></li>
									<li><a href="#setup">Setup</a></li>
									<li><a href="#work-on-it">Work on it</a></li>
								</ul>
							</li>
							<li><a href="#test">Test</a></li>
							<li><a href="#deploy">Deploy</a></li>
							<li><a href="#api-interaction--documentation">API Interaction + Documentation</a></li>
							<li><a href="#docs">Docs</a></li>
							<li><a href="#how-to-connect-a-ttn-application-with-iot-data-hub">HOW TO: connect a TTN application with IoT Data Hub</a><ul>
									<li><a href="#step-1-sensor">Step 1: sensor</a></li>
									<li><a href="#step-2-payload-aka-decoder-function">Step 2: payload aka. decoder function</a></li>
									<li><a href="#step-3-http-integration">Step 3: HTTP Integration</a></li>
								</ul>
							</li>
						</ul>
					</li>
				</ul>
				<!-- /code_chunk_output -->
				<a href="#berlin-iot-hub-technology-stack" id="berlin-iot-hub-technology-stack" style="color: inherit; text-decoration: none;">
					<h2>Berlin IoT Hub Technology Stack</h2>
				</a>
				<p>The Berlin IoT Hub consists of two components, namely: an RESTful API and a frontend. All of these components are administrated within their very own Repository stored in</p>
				<ul>
					<li><a href="https://github.com/technologiestiftung/berlin-datahub-api">github.com/technologiestiftung/berlin-datahub-api</a></li>
					<li><a href="https://github.com/technologiestiftung/berlin-iot-hub-frontend">github.com/technologiestiftung/berlin-iot-hub-frontend</a></li>
				</ul>
				<p><img src="images/berlin-IoT-hub-diagram.png" alt="Technology Stack"></p>
				<a href="#development" id="development" style="color: inherit; text-decoration: none;">
					<h2>Development</h2>
				</a>
				<p>The API is written in Typescript and uses Express.js + and Prisma.</p>
				<a href="#environment-variables" id="environment-variables" style="color: inherit; text-decoration: none;">
					<h3>Environment Variables</h3>
				</a>
				<p>You can find an example <code>.env</code> file under <a href="./prisma/env.example">./prisma/env.example</a>. Make sure to obtain an <a href="https://logdna.com/">LogDNA Key</a> to connect to your account. (You can get this by going to the addon section on render.com).</p>
				<a href="#prerequisites" id="prerequisites" style="color: inherit; text-decoration: none;">
					<h3>Prerequisites</h3>
				</a>
				<ul>
					<li>Node.js &gt;= 12</li>
					<li>Docker &gt;= 19</li>
				</ul>
				<a href="#setup" id="setup" style="color: inherit; text-decoration: none;">
					<h3>Setup</h3>
				</a>
				<pre><code class="language-bash">
docker-compose up
npm ci</code></pre>
				<a href="#work-on-it" id="work-on-it" style="color: inherit; text-decoration: none;">
					<h3>Work on it</h3>
				</a>
				<pre><code class="language-bash"><span class="hljs-comment"># Assumes you habe a posstgres DB running</span>
npm run dev</code></pre>
				<a href="#test" id="test" style="color: inherit; text-decoration: none;">
					<h2>Test</h2>
				</a>
				<p>Uses Jest. Prisma creates for each test run a sqlite DB. Currently this is fine. We might need to switch to a Postgres setup later on.</p>
				<pre><code class="language-bash">npm t</code></pre>
				<a href="#deploy" id="deploy" style="color: inherit; text-decoration: none;">
					<h2>Deploy</h2>
				</a>
				<p>The API is deployed to <a href="https://render.com">render.com</a>. You can find all definition in <a href="render.yaml">render.yaml</a>. Deploy via Infrastructure as Code. Don&#39;t forget to add your environment variables.</p>
				<a href="#api-interaction--documentation" id="api-interaction--documentation" style="color: inherit; text-decoration: none;">
					<h2>API Interaction + Documentation</h2>
				</a>
				<p>This api provides some endpoints for posting data over HTTP. You need an user account to do that. You can find many examples in the file <a href="http-requests/api.http">http-requests/api.http</a>. This file can be used with the <a href="https://github.com/Huachao/vscode-restclient">VSCode Rest Client Extension</a>. Make sure to create your <code>.env</code> file there from the provided example under <a href="./http-requests/env.example">./http-requests/env.example</a>.</p>
				<a href="#docs" id="docs" style="color: inherit; text-decoration: none;">
					<h2>Docs</h2>
				</a>
				<p>Docs are generated using <a href="http://typedoc.org/">typedoc</a> and deployed to <a href="https://technologiestiftung.github.io/berlin-datahub-api/">github pages</a>.</p>
				<a href="#how-to-connect-a-ttn-application-with-iot-data-hub" id="how-to-connect-a-ttn-application-with-iot-data-hub" style="color: inherit; text-decoration: none;">
					<h2>HOW TO: connect a TTN application with IoT Data Hub</h2>
				</a>
				<p>If you want to connect you very own TTN application and their devices with the IoT Data Hub you&#39;ll need:</p>
				<ol>
					<li>a sensor which measures something</li>
					<li>a proper payload aka. decoder function</li>
					<li>to activate the official TTN HTTP Integration and configurate it</li>
				</ol>
				<a href="#step-1-sensor" id="step-1-sensor" style="color: inherit; text-decoration: none;">
					<h3>Step 1: sensor</h3>
				</a>
				<p>This is the most obvious step and propably comes by default if you already found your way to our repo. To show the data which was measured by your sensors in the IoT Data Hub, of course, you&#39;ll need a sensor which already measures some data e.g. temperature, CO2, dezibel, pressure etc.., first.</p>
				<a href="#step-2-payload-aka-decoder-function" id="step-2-payload-aka-decoder-function" style="color: inherit; text-decoration: none;">
					<h3>Step 2: payload aka. decoder function</h3>
				</a>
				<p>So far, our API only can handle <strong>one record</strong> per device. In order to handle the incoming payloads in a way our API is aware of what is happening, you simply have to update the payload aka. decoder function in your very own TTN application. You measrued data, e.g. CO2 value, needs to be returned as &quot;value&quot; otherwise our API wont recognize it. Please see the following example for a simple CO2-sensor below:</p>
				<pre><code class="language-javascript"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Decoder</span>(<span class="hljs-params">bytes</span>) </span>{
  <span class="hljs-keyword">var</span> myCO2;
  <span class="hljs-comment">//if no value was measured return 0</span>
  <span class="hljs-keyword">if</span> (!bytes[<span class="hljs-number">0</span>]) {
    myCO2 = <span class="hljs-number">0</span>;
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-comment">//cuz co2 sensors usually delivery records higher than 255 we look at 2 bytes of the uplink</span>
    myCO2 = (bytes[<span class="hljs-number">1</span>] &lt;&lt; <span class="hljs-number">8</span>) | bytes[<span class="hljs-number">0</span>];
  }

  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">now</span>: <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>().toISOString(),
    <span class="hljs-attr">value</span>: myCO2,
  };
}</code></pre>
				<p>You can simply test your decoder function by simulating an uplink. In our case we simply used a payload with the hexadecimal values of <strong>01 05</strong>. Our decoder function now returns us a decimal value of 1281. Time to open the window and let some fresh air in!</p>
				<p><img src="images/HowTo_payloadFormat.png" alt="Payload Format"></p>
				<a href="#step-3-http-integration" id="step-3-http-integration" style="color: inherit; text-decoration: none;">
					<h3>Step 3: HTTP Integration</h3>
				</a>
				<p>The IoT Data Hub uses a RESTful API and therefore can be used by any device which is communicating over HTTP. Luckily, the TTN Community already provides a very powerful built-in integration to wire the incoming payload messages (MQTT) with the HTTP protocol. To use this HTTP integration for the API, simply follow these steps:</p>
				<ol>
					<li>navigate to the overview of your TTN application</li>
					<li>in the menu to the top right click on <strong>Integrtions</strong></li>
					<li>choose <strong>HTTP Integration</strong> to activate it</li>
					<li>enter a process ID e.g. berlin-datahub-co2</li>
					<li>enter the URL: <a href="https://berlin-datahub-api.onrender.com/api/ttn">https://berlin-datahub-api.onrender.com/api/ttn</a></li>
					<li>enter Method: POST</li>
					<li>enter &quot;Bearer&quot; + your very own Authorization token (you&#39;&#39;ll get this from the admin of the IoT Data Hub by request --&gt; just send us a ping)</li>
				</ol>
				<p><img src="images/HowTo_HTTPintegration.png" alt="Payload Format"></p>
				<p>By finally setting up the HTTP integration, your part is done and everything should work as expected. Yeah. However, if you&#39;re going to test the API be simulating some uplinks, you&#39;ll will notice that no record and even no application will appear in the IoT Data Hub Frontend.</p>
				<p>Don&#39;t worry! This is because we have to add your application and your sending device manually first. So: please don&#39;t hesitate to get in contact and tell us your AppID &amp; the ID of your device(s) which is/are sending. We will send you your very own Authorization token and configure our DB so you can finally see your sensor data <a href="https://berlin-iot-hub.netlify.app/">our Frontend</a></p>
			</div>
		</div>
		<div class="col-4 col-menu menu-sticky-wrap menu-highlight">
			<nav class="tsd-navigation primary">
				<ul>
					<li class="globals  ">
						<a href="globals.html"><em>Globals</em></a>
					</li>
					<li class=" tsd-kind-module">
						<a href="modules/_common_interfaces_.html">&quot;common/interfaces&quot;</a>
					</li>
					<li class=" tsd-kind-module">
						<a href="modules/_common_types_.html">&quot;common/types&quot;</a>
					</li>
					<li class=" tsd-kind-module">
						<a href="modules/_index_.html">&quot;index&quot;</a>
					</li>
					<li class=" tsd-kind-module">
						<a href="modules/_lib_api_routes_.html">&quot;lib/api-<wbr>routes&quot;</a>
					</li>
					<li class=" tsd-kind-module">
						<a href="modules/_lib_envs_.html">&quot;lib/envs&quot;</a>
					</li>
					<li class=" tsd-kind-module">
						<a href="modules/_lib_logger_.html">&quot;lib/logger&quot;</a>
					</li>
					<li class=" tsd-kind-module">
						<a href="modules/_lib_middlewares_.html">&quot;lib/middlewares&quot;</a>
					</li>
					<li class=" tsd-kind-module">
						<a href="modules/_lib_prisma_.html">&quot;lib/prisma&quot;</a>
					</li>
					<li class=" tsd-kind-module">
						<a href="modules/_lib_rate_limiters_.html">&quot;lib/rate-<wbr>limiters&quot;</a>
					</li>
					<li class=" tsd-kind-module">
						<a href="modules/_lib_request_handlers_devices_.html">&quot;lib/request-<wbr>handlers/devices&quot;</a>
					</li>
					<li class=" tsd-kind-module">
						<a href="modules/_lib_request_handlers_projects_.html">&quot;lib/request-<wbr>handlers/projects&quot;</a>
					</li>
					<li class=" tsd-kind-module">
						<a href="modules/_lib_request_handlers_records_.html">&quot;lib/request-<wbr>handlers/records&quot;</a>
					</li>
					<li class=" tsd-kind-module">
						<a href="modules/_lib_request_handlers_status_.html">&quot;lib/request-<wbr>handlers/status&quot;</a>
					</li>
					<li class=" tsd-kind-module">
						<a href="modules/_lib_request_handlers_users_.html">&quot;lib/request-<wbr>handlers/users&quot;</a>
					</li>
					<li class=" tsd-kind-module">
						<a href="modules/_lib_utils_.html">&quot;lib/utils&quot;</a>
					</li>
					<li class=" tsd-kind-module">
						<a href="modules/_server_.html">&quot;server&quot;</a>
					</li>
					<li class=" tsd-kind-module">
						<a href="modules/_test_helpers_.html">&quot;test/helpers&quot;</a>
					</li>
				</ul>
			</nav>
			<nav class="tsd-navigation secondary menu-sticky">
				<ul class="before-current">
				</ul>
			</nav>
		</div>
	</div>
</div>
<footer class="with-border-bottom">
	<div class="container">
		<h2>Legend</h2>
		<div class="tsd-legend-group">
			<ul class="tsd-legend">
				<li class="tsd-kind-object-literal"><span class="tsd-kind-icon">Object literal</span></li>
				<li class="tsd-kind-variable"><span class="tsd-kind-icon">Variable</span></li>
				<li class="tsd-kind-function"><span class="tsd-kind-icon">Function</span></li>
				<li class="tsd-kind-function tsd-has-type-parameter"><span class="tsd-kind-icon">Function with type parameter</span></li>
				<li class="tsd-kind-type-alias"><span class="tsd-kind-icon">Type alias</span></li>
			</ul>
			<ul class="tsd-legend">
				<li class="tsd-kind-interface"><span class="tsd-kind-icon">Interface</span></li>
			</ul>
		</div>
	</div>
</footer>
<div class="container tsd-generator">
	<p>Generated using <a href="https://typedoc.org/" target="_blank">TypeDoc</a></p>
</div>
<div class="overlay"></div>
<script src="assets/js/main.js"></script>
</body>
</html>